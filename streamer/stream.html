<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>mferGPT plays pokemon</title>
<style>
  @font-face {
    font-family: 'SartoshiScript';
    src: url('/SartoshiScript-Regular.otf') format('opentype');
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    background: #0a0a0f;
    color: #e0e0e0;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 8px #ffb67033; }
    50% { box-shadow: 0 0 16px #ffb67055; }
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes subtlePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* ‚îÄ‚îÄ‚îÄ TITLE BAR ‚îÄ‚îÄ‚îÄ */
  .title-bar {
    height: 56px;
    flex-shrink: 0;
    background: linear-gradient(135deg, #12121a 0%, #0f1528 50%, #12121a 100%);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    border-bottom: 2px solid #ffb670;
    position: relative;
    z-index: 10;
  }

  .title-bar::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, #ffb67044, transparent);
  }

  .title-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .title {
    font-family: 'SartoshiScript', cursive;
    font-size: 44px;
    color: #ffb670;
    letter-spacing: 1px;
    text-shadow: 0 0 20px #ffb67044;
  }

  .live-dot {
    display: inline-block;
    width: 8px; height: 8px;
    background: #ef4444;
    border-radius: 50%;
    margin-right: 6px;
    animation: subtlePulse 2s ease-in-out infinite;
    box-shadow: 0 0 8px #ef444488;
  }

  .title-pills {
    display: flex;
    gap: 10px;
    font-size: 15px;
  }

  .pill {
    background: #ffffff06;
    padding: 5px 14px;
    border-radius: 8px;
    border: 1px solid #ffffff0a;
    color: #666;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .pill .val { color: #ffb670; font-weight: bold; }
  .pill .label { color: #555; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }

  /* Token tickers */
  .ticker-group {
    display: flex;
    gap: 10px;
  }

  .ticker {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #ffffff06;
    padding: 5px 14px;
    border-radius: 8px;
    border: 1px solid #ffffff0a;
    font-size: 14px;
  }

  .ticker .name { color: #ffb670; font-weight: bold; font-size: 13px; }
  .ticker .price { color: #fff; font-weight: bold; }
  .ticker .change { font-weight: bold; font-size: 13px; }
  .ticker .change.up { color: #22c55e; }
  .ticker .change.down { color: #ef4444; }
  .ticker .change.flat { color: #666; }
  .ticker .change-label { font-size: 9px; color: #444; margin-left: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

  /* ‚îÄ‚îÄ‚îÄ TOP ROW (webcam + feeds) ‚îÄ‚îÄ‚îÄ */
  .top-row {
    height: 200px;
    flex-shrink: 0;
    display: grid;
    grid-template-columns: clamp(220px, 16vw, 320px) 1fr 1fr;
    border-bottom: 2px solid #ffb670;
    position: relative;
  }

  .top-row::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, #ffb67044, transparent);
  }

  /* ‚îÄ‚îÄ‚îÄ WEBCAM ‚îÄ‚îÄ‚îÄ */
  .webcam-area {
    position: relative;
    background: #ffb670;
    overflow: hidden;
  }

  .webcam-area iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* ‚îÄ‚îÄ‚îÄ CURRENT SPEECH (in sidebar) ‚îÄ‚îÄ‚îÄ */
  .current-speech {
    background: linear-gradient(135deg, #141420, #181830);
    border: 1px solid #ffb67044;
    border-radius: 10px;
    padding: 8px 12px;
    min-height: 36px;
    animation: pulseGlow 4s ease-in-out infinite;
    transition: opacity 0.3s;
  }

  .current-speech.dimmed {
    opacity: 0.4;
    animation: none;
  }

  .current-speech .emotion-tag {
    font-family: 'SartoshiScript', cursive;
    font-size: 16px;
    color: #ffb670;
    margin-right: 6px;
  }

  .current-speech .msg {
    font-size: 15px;
    line-height: 1.5;
    color: #d0d0d0;
  }

  .current-speech .typing-cursor {
    display: inline-block;
    width: 2px;
    height: 12px;
    background: #ffb670;
    margin-left: 2px;
    vertical-align: middle;
    animation: blink 1s step-end infinite;
  }

  /* ‚îÄ‚îÄ‚îÄ FEEDS ‚îÄ‚îÄ‚îÄ */
  .feed-panel {
    background: linear-gradient(180deg, #0e0e16, #101018);
    padding: 8px 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border-left: 1px solid #1a1a2e;
  }

  .feed-panel h3 {
    font-family: 'SartoshiScript', cursive;
    font-size: 20px;
    color: #ffb670;
    margin-bottom: 4px;
    flex-shrink: 0;
    text-shadow: 0 0 10px #ffb67022;
  }

  .feed-entries {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    font-size: 13px;
    line-height: 1.4;
    gap: 3px;
  }

  .feed-entry {
    padding: 4px 8px;
    color: #ccc;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-radius: 4px;
    background: #ffffff06;
    flex-shrink: 0;
    animation: fadeInUp 0.3s ease;
    font-size: 15px;
  }

  .feed-entry .username { color: #ffb670; font-weight: 600; margin-right: 6px; }
  .feed-entry .text { color: #ddd; }

  /* ‚îÄ‚îÄ‚îÄ MAIN AREA (stats left + game right) ‚îÄ‚îÄ‚îÄ */
  .main-area {
    flex: 1;
    display: grid;
    grid-template-columns: clamp(240px, 18vw, 340px) 1fr clamp(240px, 18vw, 340px);
    min-height: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ STATS SIDEBAR (left) ‚îÄ‚îÄ‚îÄ */
  .stats-sidebar {
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow: hidden;
    background: linear-gradient(180deg, #0e0e16 0%, #101018 100%);
    border-right: 1px solid #1a1a2e;
  }

  .stat-section h3 {
    font-family: 'SartoshiScript', cursive;
    font-size: 22px;
    color: #ffb670;
    margin-bottom: 3px;
    text-shadow: 0 0 10px #ffb67022;
  }

  /* Trainer row */
  .trainer-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .stat-box {
    background: linear-gradient(135deg, #14141e, #18182a);
    border-radius: 8px;
    padding: 7px 10px;
    border: 1px solid #252540;
  }
  .stat-box .label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1px; }
  .stat-box .value { font-size: 18px; color: #fff; font-weight: bold; margin-top: 1px; }
  .stat-box .value.small { font-size: 12px; }

  /* Badges */
  .badges-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .badge-dot {
    width: 26px; height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
  }

  .badge-dot.earned {
    background: linear-gradient(135deg, #ffb670, #ff8c00);
    color: #000;
    box-shadow: 0 0 10px #ffb67066;
  }
  .badge-dot.unearned { background: #16161e; color: #333; border: 1px solid #252540; }

  /* Team */
  .team-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px;
  }

  .pkmn-card {
    background: linear-gradient(135deg, #14141e, #1a1a2e);
    border-radius: 8px;
    padding: 7px 9px;
    border: 1px solid #252540;
  }

  .pkmn-head {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  .pkmn-name { font-size: 15px; font-weight: bold; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
  .pkmn-lv { font-size: 13px; color: #666; }

  .hp-bar {
    height: 4px;
    background: #1a1a2e;
    border-radius: 2px;
    margin-top: 4px;
    overflow: hidden;
  }

  .hp-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, #22c55e, #4ade80); transition: width 0.5s; }
  .hp-fill.low { background: linear-gradient(90deg, #eab308, #facc15); }
  .hp-fill.critical { background: linear-gradient(90deg, #dc2626, #f87171); }

  .pkmn-hp { font-size: 12px; color: #555; margin-top: 2px; font-family: 'JetBrains Mono', monospace; }

  .pkmn-xp-bar {
    height: 3px;
    background: #1a1a2e;
    border-radius: 2px;
    margin-top: 2px;
    overflow: hidden;
  }
  .pkmn-xp-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.5s; }

  /* Minimap */
  .minimap-container {
    background: #0e0e16;
    border-radius: 8px;
    padding: 3px;
    border: 1px solid #252540;
    display: flex;
    align-items: center;
    justify-content: center;
    max-height: 130px;
    overflow: hidden;
  }

  .minimap-container img { max-width: 100%; max-height: 124px; image-rendering: pixelated; }

  /* Counters row */
  .counters-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 5px;
  }

  .counter-box {
    background: linear-gradient(135deg, #14141e, #18182a);
    border-radius: 8px;
    padding: 5px 8px;
    border: 1px solid #252540;
    text-align: center;
  }
  .counter-box .label { font-size: 9px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
  .counter-box .value { font-size: 16px; color: #fff; font-weight: bold; }
  .counter-box .value.deaths { color: #ef4444; }

  /* Recent thoughts */
  .recent-thoughts {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .thought-entry {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 6px;
    background: linear-gradient(135deg, #14141e, #181830);
    border: 1px solid #252540;
    border-left: 2px solid #ffb67044;
    color: #aaa;
    line-height: 1.4;
    animation: slideIn 0.3s ease;
  }

  .thought-entry .emotion {
    font-family: 'SartoshiScript', cursive;
    color: #ffb670;
    font-size: 13px;
    margin-right: 4px;
  }

  /* ‚îÄ‚îÄ‚îÄ BATTLE INFO ‚îÄ‚îÄ‚îÄ */
  .battle-info {
    background: linear-gradient(135deg, #1a1420, #201830);
    border: 1px solid #ff4444aa;
    border-radius: 10px;
    padding: 8px 12px;
    font-size: 13px;
    line-height: 1.5;
  }

  .battle-info .battle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 0;
  }

  .battle-info .battle-label { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
  .battle-info .battle-val { color: #fff; font-weight: 600; }
  .battle-info .enemy-name { color: #ef4444; font-weight: 700; }
  .battle-info .player-name { color: #22c55e; font-weight: 700; }

  .battle-hp {
    height: 4px;
    background: #1a1a2e;
    border-radius: 2px;
    margin-top: 3px;
    overflow: hidden;
    width: 100%;
  }
  .battle-hp .fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
  .battle-hp .fill.enemy { background: linear-gradient(90deg, #ef4444, #f87171); }
  .battle-hp .fill.player { background: linear-gradient(90deg, #22c55e, #4ade80); }

  /* ‚îÄ‚îÄ‚îÄ ACTIVITY LOG ‚îÄ‚îÄ‚îÄ */
  .activity-log {
    display: flex;
    flex-direction: column;
    gap: 3px;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .activity-entry {
    font-size: 12px;
    padding: 3px 8px;
    border-radius: 4px;
    background: #ffffff06;
    color: #999;
    animation: fadeInUp 0.2s ease;
    display: flex;
    gap: 6px;
    align-items: baseline;
  }

  .activity-entry .action-icon { font-size: 10px; flex-shrink: 0; }
  .activity-entry .action-text { flex: 1; }
  .activity-entry.success .action-text { color: #aaa; }
  .activity-entry.fail .action-text { color: #ef4444; }

  /* ‚îÄ‚îÄ‚îÄ RIGHT SIDEBAR ‚îÄ‚îÄ‚îÄ */
  .right-sidebar {
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow: hidden;
    background: linear-gradient(180deg, #0e0e16 0%, #101018 100%);
    border-left: 1px solid #1a1a2e;
  }

  .right-sidebar h3 {
    font-family: 'SartoshiScript', cursive;
    font-size: 22px;
    color: #ffb670;
    margin-bottom: 3px;
    text-shadow: 0 0 10px #ffb67022;
  }

  .status-section {
    flex-shrink: 0;
  }

  .phase-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #14141e, #1a1a2e);
    border-radius: 10px;
    padding: 8px 12px;
    border: 1px solid #252540;
  }

  .phase-icon { font-size: 16px; }
  .phase-text { font-size: 14px; font-weight: 600; color: #fff; flex: 1; }
  .step-num { font-size: 11px; color: #555; }

  @keyframes pulseGreen {
    0%, 100% { box-shadow: 0 0 6px #22c55e33; }
    50% { box-shadow: 0 0 18px #22c55e66; }
  }
  @keyframes pulseYellow {
    0%, 100% { box-shadow: 0 0 6px #eab30833; }
    50% { box-shadow: 0 0 18px #eab30866; }
  }
  @keyframes pulseRed {
    0%, 100% { box-shadow: 0 0 6px #ef444433; }
    50% { box-shadow: 0 0 18px #ef444466; }
  }
  .phase-badge.playing { border-color: #22c55e44; animation: pulseGreen 2s ease-in-out infinite; }
  .phase-badge.playing .phase-text { color: #22c55e; }
  .phase-badge.thinking { border-color: #eab30844; animation: pulseYellow 1.5s ease-in-out infinite; }
  .phase-badge.thinking .phase-text { color: #eab308; }
  .phase-badge.summarizing { border-color: #ef444444; animation: pulseRed 2s ease-in-out infinite; }
  .phase-badge.summarizing .phase-text { color: #ef4444; }
  .phase-badge.error { border-color: #ef444444; }
  .phase-badge.error .phase-text { color: #ef4444; }

  /* ‚îÄ‚îÄ‚îÄ GAME PANEL (center, big) ‚îÄ‚îÄ‚îÄ */
  .game-panel {
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .game-placeholder {
    width: 100%;
    height: 100%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .game-placeholder img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .game-panel iframe { width: 100%; height: 100%; border: none; position: relative; z-index: 1; }

  .summarizing-overlay {
    position: absolute;
    bottom: 12px;
    left: 14px;
    font-family: 'SartoshiScript', cursive;
    font-size: 22px;
    color: #6496ff;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    z-index: 50;
    text-shadow: 0 0 8px rgba(0,0,0,0.8), 0 0 16px rgba(0,0,0,0.5);
  }
  .summarizing-overlay.visible { opacity: 1; }
  @media (max-width: 768px) {
    .summarizing-overlay { font-size: 18px; bottom: 8px; left: 10px; }
  }

  .splash-overlay {
    position: absolute;
    top: 20px;
    right: 20px;
    font-family: 'SartoshiScript', cursive;
    font-size: 44px;
    color: #ffb670;
    text-align: right;
    line-height: 1.3;
    text-shadow: 0 0 40px #ffb67088, 0 2px 10px rgba(0,0,0,0.9), 0 0 80px rgba(0,0,0,0.7);
    background: rgba(0, 0, 0, 0.5);
    padding: 16px 28px;
    border-radius: 12px;
    animation: subtlePulse 3s ease-in-out infinite;
    z-index: 10;
    max-width: 45%;
  }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 1400px) {
    .title { font-size: 36px; }
    .title-pills { gap: 6px; font-size: 13px; }
    .pill { padding: 4px 10px; }
    .ticker { font-size: 12px; padding: 4px 10px; }
    .stat-section h3 { font-size: 18px; }
    .stat-box .value { font-size: 15px; }
    .pkmn-name { font-size: 11px; }
    .pkmn-lv { font-size: 10px; }
    .counter-box .value { font-size: 14px; }
    .action-entry { font-size: 10px; }
    .feed-entries { font-size: 12px; }
    .speech-bubble { font-size: 11px; }
  }

  @media (max-width: 1100px) {
    .title-bar { padding: 0 14px; height: 48px; }
    .title { font-size: 28px; }
    .ticker-group { gap: 6px; }
    .ticker .name { font-size: 11px; }
    .title-pills { font-size: 11px; }
    .team-grid { grid-template-columns: 1fr; }
    .trainer-row { grid-template-columns: 1fr; }
    .counters-row { grid-template-columns: 1fr 1fr; }
    .top-row { height: 160px; grid-template-columns: clamp(180px, 18vw, 280px) 1fr 1fr; }
    .feed-panel h3 { font-size: 16px; }
  }

  @media (max-width: 800px) {
    .ticker-group { display: none; }
    .title-pills { flex-wrap: wrap; }
    .top-row { grid-template-columns: 1fr 1fr; }
    .webcam-area { display: none; }
    .stats-sidebar { padding: 8px 10px; gap: 6px; }
    .main-area { grid-template-columns: 1fr; }
    .right-sidebar { display: none; }
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ TITLE BAR ‚îÄ‚îÄ‚îÄ -->
<div class="title-bar">
  <div class="title-left">
    <div class="title"><span class="live-dot"></span>mfergpt plays pokemon</div>
  </div>
  <div class="title-pills">
    <!-- removed: step/model/uptime pills -->
  </div>
  <div class="ticker-group">
    <div class="ticker">
      <span class="name">$MFERGPT</span>
      <span class="price" id="mfergpt-price">-</span>
      <span class="change-label">5m</span><span class="change flat" id="mfergpt-change">-</span>
      <span class="change-label">24h</span><span class="change flat" id="mfergpt-change-24h">-</span>
    </div>
    <div class="ticker">
      <span class="name">$MFER</span>
      <span class="price" id="mfer-price">-</span>
      <span class="change-label">5m</span><span class="change flat" id="mfer-change">-</span>
      <span class="change-label">24h</span><span class="change flat" id="mfer-change-24h">-</span>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TOP ROW (webcam + feeds) ‚îÄ‚îÄ‚îÄ -->
<div class="top-row">
  <div class="webcam-area">
    <iframe src="/webcam" id="webcam-frame"></iframe>
  </div>
  <div class="feed-panel">
    <h3>üê¶ mentions</h3>
    <div class="feed-entries" id="mentions-feed"></div>
  </div>
  <div class="feed-panel">
    <h3>üí¨ twitch chat</h3>
    <div class="feed-entries" id="twitch-feed"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ MAIN AREA (stats left + game right) ‚îÄ‚îÄ‚îÄ -->
<div class="main-area">
  <!-- LEFT: Stats sidebar -->
  <div class="stats-sidebar" id="stats-sidebar">
    <div class="stat-section">
      <div class="trainer-row">
        <div class="stat-box">
          <div class="label">Money</div>
          <div class="value" id="money">$0</div>
        </div>
        <div class="stat-box">
          <div class="label">Location</div>
          <div class="value small" id="location">-</div>
        </div>
      </div>
    </div>

    <div class="stat-section">
      <div class="badges-row" id="badges-row"></div>
    </div>

    <div class="stat-section">
      <h3>team</h3>
      <div class="team-grid" id="team-grid">
        <div class="pkmn-card"><div class="pkmn-lv">waiting...</div></div>
      </div>
    </div>

    <!-- counters removed: server doesn't track encounters/caught/whiteouts yet -->

    <div class="stat-section" id="battle-section" style="display:none;">
      <h3>battle</h3>
      <div class="battle-info" id="battle-info"></div>
    </div>

    <div class="stat-section" style="flex:1;min-height:0;display:flex;flex-direction:column;">
      <h3>activity</h3>
      <div class="activity-log" id="activity-log"></div>
    </div>

  </div>

  <!-- CENTER: Game -->
  <div class="game-panel">
    <div class="game-placeholder" id="game-placeholder">
      <img src="/splash.png" alt="mfergpt plays pokemon">
      <div class="splash-overlay"></div>
    </div>
    <div class="summarizing-overlay" id="summarizing-overlay">summarizing... may take a few minutes</div>
  </div>

  <!-- RIGHT: Thoughts + Status sidebar -->
  <div class="right-sidebar" id="right-sidebar">
    <div class="status-section">
      <div class="phase-badge" id="phase-badge">
        <span class="phase-icon" id="phase-icon">üü¢</span>
        <span class="phase-text" id="phase-text">playing</span>
        <span class="step-num" id="step-num">step --</span>
      </div>
    </div>

    <div class="stat-section" id="minimap-section" style="display:none;">
      <div class="minimap-container" id="minimap-container">
        <img id="minimap-img" src="" alt="minimap" style="display:none;">
      </div>
    </div>

    <div class="stat-section" style="flex:1;min-height:0;display:flex;flex-direction:column;">
      <h3>thoughts</h3>
      <div class="recent-thoughts" id="recent-thoughts"></div>
    </div>
  </div>
</div>

<script>
const WS_HOST = window.location.hostname || 'localhost';
const WS_PORT = 9885;
const STREAMER_PORT = window.location.port || 9886;
const MINIMAP_URL = `http://${WS_HOST}:${WS_PORT}/minimapSnapshot`;
const MODEL_URL = `http://${WS_HOST}:${WS_PORT}/api/model`;

const BADGE_NAMES = ['BOULDER','CASCADE','THUNDER','RAINBOW','SOUL','MARSH','VOLCANO','EARTH'];
const BADGE_SHORT = ['B','C','T','R','S','M','V','E'];

let tokenHistory = [];
const TOKEN_RATE_WINDOW_MS = 5 * 60 * 1000;

let ws = null;
let logs = [];
const MAX_LOGS = 8;
let speechTimeout = null;
let counters = { encounters: 0, whiteouts: 0, caught: 0 };

const badgesRow = document.getElementById('badges-row');
badgesRow.innerHTML = BADGE_NAMES.map((name, i) => 
  `<div class="badge-dot unearned" id="badge-${name}" title="${name}">${BADGE_SHORT[i]}</div>`
).join('');

function connect() {
  ws = new WebSocket(`ws://${WS_HOST}:${WS_PORT}`);
  ws.onmessage = (event) => {
    try { handleMessage(JSON.parse(event.data)); } catch (e) { console.error('WS msg error:', e); }
  };
  ws.onclose = () => setTimeout(connect, 3000);
  ws.onerror = () => {};
}

let activityLog = [];
const MAX_ACTIVITY = 12;
const ACTION_ICONS = {
  key_press: 'üéÆ', a_until_end_of_dialog: 'üí¨', move_character: 'üö∂',
  path_to_location: 'üó∫Ô∏è', wait: '‚è≥', default: '‚ö°'
};

function handleMessage(msg) {
  const type = msg.type;
  const p = msg.payload || msg;
  if (type === 'full_state' || type === 'state_update') updateStats(p);
  if (type === 'action_start') { updateAction(p); updatePhase('playing', p.step); }
  if (type === 'action_executed') { addActivity(p); }
  if (type === 'token_usage_total' || type === 'token_usage') updateTokens(p);
  if (type === 'summary_start' || type === 'summary_begin') updatePhase('summarizing');
  if (type === 'summary_end') updatePhase('playing');
  if (type === 'error_message') updatePhase('error');
}

function addActivity(data) {
  const icon = ACTION_ICONS[data.action_type] || ACTION_ICONS.default;
  const text = data.action_type ? data.action_type.replace(/_/g, ' ') : '?';
  const detail = data.message ? ` ‚Äî ${data.message}`.substring(0, 60) : '';
  activityLog.unshift({ icon, text: text + detail, success: data.success });
  if (activityLog.length > MAX_ACTIVITY) activityLog.pop();
  renderActivity();
}

function renderActivity() {
  const el = document.getElementById('activity-log');
  el.innerHTML = activityLog.map(a => `
    <div class="activity-entry ${a.success ? 'success' : 'fail'}">
      <span class="action-icon">${a.icon}</span>
      <span class="action-text">${escapeHtml(a.text)}</span>
    </div>
  `).join('');
}

function updatePhase(phase, step) {
  const badge = document.getElementById('phase-badge');
  const icons = { playing: 'üü¢', thinking: 'üß†', summarizing: 'üìù', error: '‚ö†Ô∏è' };
  badge.className = `phase-badge ${phase}`;
  document.getElementById('phase-icon').textContent = icons[phase] || 'üü¢';
  document.getElementById('phase-text').textContent = phase;
  if (step) document.getElementById('step-num').textContent = `step ${step}`;
  const sumOverlay = document.getElementById('summarizing-overlay');
  if (sumOverlay) sumOverlay.classList.toggle('visible', phase === 'summarizing');
}

// Poll streamer state for phase + thoughts fallback (in case WS isn't connected)
let lastPollStep = -1;
async function pollPhase() {
  try {
    const res = await fetch(`http://${WS_HOST}:${STREAMER_PORT}/api/streamer-state`);
    if (!res.ok) return;
    const data = await res.json();
    if (data.phase) updatePhase(data.phase);
    if (data.step) document.getElementById('step-num').textContent = `step ${data.step}`;
    
    // Fallback: update thoughts + speech from poll if WS missed it
    if (data.step && data.step !== lastPollStep) {
      lastPollStep = data.step;
      if (data.chat_message) {
        // Add to thoughts log
        logs.unshift({ msg: data.chat_message, emotion: data.emotion || '' });
        if (logs.length > MAX_LOGS) logs.pop();
        renderThoughts();
      }
    }
  } catch(e) {}
}
setInterval(pollPhase, 2000);

function updateStats(data) {
  const trainer = data.current_trainer_data;
  if (trainer) {
    const money = trainer.money || 0;
    document.getElementById('money').textContent = `$${money.toLocaleString()}`;
    // money-pill removed from UI
    const badges = trainer.badges || {};
    const earnedCount = Object.keys(badges).filter(k => badges[k]).length;
    // badge-count-pill removed from UI
    
    const pos = trainer.position || {};
    const mapName = (pos.map_name || '-').replace(/_/g, ' ');
    document.getElementById('location').textContent = mapName;
    
    BADGE_NAMES.forEach(name => {
      const el = document.getElementById(`badge-${name}`);
      if (el) el.className = badges[name] ? 'badge-dot earned' : 'badge-dot unearned';
    });
  }
  
  const team = data.current_pokemon_data || [];
  const teamGrid = document.getElementById('team-grid');
  if (team.length > 0) {
    teamGrid.innerHTML = team.map(p => {
      const maxHp = p.max_hp || 1;
      const curHp = p.current_hp || 0;
      const pct = Math.max(0, Math.min(100, (curHp / maxHp) * 100));
      const hpClass = pct <= 20 ? 'critical' : pct <= 50 ? 'low' : '';
      const xpPct = p.xp_to_next ? Math.max(0, Math.min(100, ((p.xp_current || 0) / p.xp_to_next) * 100)) : 0;
      return `
        <div class="pkmn-card">
          <div class="pkmn-head">
            <div class="pkmn-name">${p.nickname || p.species_name || '?'}</div>
            <div class="pkmn-lv">Lv${p.level || 0}</div>
          </div>
          <div class="hp-bar"><div class="hp-fill ${hpClass}" style="width:${pct}%"></div></div>
          <div class="pkmn-hp">${curHp}/${maxHp}</div>
          ${p.xp_to_next ? `<div class="pkmn-xp-bar"><div class="pkmn-xp-fill" style="width:${xpPct}%"></div></div>` : ''}
        </div>`;
    }).join('');
  }
  
  // Team count pill
  // team-count-pill removed from UI
  
  if (data.total_tokens_accumulated) {
    tokenHistory.push({ ts: Date.now(), tokens: data.total_tokens_accumulated });
    const cutoff = Date.now() - TOKEN_RATE_WINDOW_MS;
    tokenHistory = tokenHistory.filter(t => t.ts > cutoff);
  }

  // Battle info
  const battle = data.battle_data || {};
  const battleSection = document.getElementById('battle-section');
  if (battle.in_battle && battle.enemy) {
    battleSection.style.display = '';
    const enemy = battle.enemy;
    const player = battle.player_pokemon;
    const enemyHpPct = enemy.max_hp ? Math.round((enemy.current_hp / enemy.max_hp) * 100) : 0;
    const playerHpPct = player?.max_hp ? Math.round((player.current_hp / player.max_hp) * 100) : 100;
    document.getElementById('battle-info').innerHTML = `
      <div class="battle-row">
        <span class="enemy-name">${escapeHtml(enemy.species || enemy.nickname || '???')} Lv${enemy.level || '?'}</span>
        <span class="battle-val">${enemy.current_hp || '?'}/${enemy.max_hp || '?'}</span>
      </div>
      <div class="battle-hp"><div class="fill enemy" style="width:${enemyHpPct}%"></div></div>
      ${battle.is_trainer_battle ? '<div style="font-size:10px;color:#eab308;margin-top:4px;">‚öîÔ∏è TRAINER BATTLE</div>' : ''}
      ${player ? `
        <div class="battle-row" style="margin-top:6px;">
          <span class="player-name">${escapeHtml(player.nickname || player.species || '???')} Lv${player.level || '?'}</span>
          <span class="battle-val">${player.current_hp || '?'}/${player.max_hp || '?'}</span>
        </div>
        <div class="battle-hp"><div class="fill player" style="width:${playerHpPct}%"></div></div>
      ` : ''}
    `;
  } else {
    battleSection.style.display = 'none';
  }
}

function updateTokens(data) {
  if (data && data.total_tokens) {
    tokenHistory.push({ ts: Date.now(), tokens: data.total_tokens });
    const cutoff = Date.now() - TOKEN_RATE_WINDOW_MS;
    tokenHistory = tokenHistory.filter(t => t.ts > cutoff);
  }
}

function updateAction(data) {
  if (data.chat_message) {
    logs.unshift({ msg: data.chat_message, emotion: data.avatar_emotion || '' });
    if (logs.length > MAX_LOGS) logs.pop();
    renderThoughts();
    // Mark this step as seen so the poll fallback doesn't duplicate it
    if (data.step) lastPollStep = data.step;
  }
}

function renderThoughts() {
  document.getElementById('recent-thoughts').innerHTML = logs.map(l => `
    <div class="thought-entry">
      <span class="emotion">${l.emotion}</span>${escapeHtml(l.msg)}
    </div>
  `).join('');
}

function escapeHtml(s) {
  return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
}

async function pollMinimap() {
  try {
    const res = await fetch(MINIMAP_URL);
    if (!res.ok) return;
    const data = await res.json();
    if (data.image_base64) {
      const img = document.getElementById('minimap-img');
      img.src = `data:image/png;base64,${data.image_base64}`;
      img.style.display = 'block';
      document.getElementById('minimap-section').style.display = '';
    }
  } catch (e) {}
}

let sessionStartTime = Date.now();
async function pollModel() {
  try {
    const res = await fetch(MODEL_URL);
    const data = await res.json();
    // model pill removed from UI
  } catch (e) {}
}

function updateUptime() {
  const elapsed = Date.now() - sessionStartTime;
  const h = Math.floor(elapsed / 3600000);
  const m = Math.floor((elapsed % 3600000) / 60000);
  // uptime pill removed from UI
}
setInterval(updateUptime, 30000);
updateUptime();

const MFERGPT_POOL = '0x23ce6e13e06fc19bb5b5948334019fc75b7d0773eddf21a72008ac0ab8753d61';
const MFER_POOL = '0xb08a99ab559e5456907278727a3b0d968c0a313b';

async function pollPrices() {
  try {
    const res = await fetch(`/api/prices`);
    if (!res.ok) return;
    const data = await res.json();
    const pairs = data.pairs || [];
    console.log('dexscreener pairs:', pairs.length, pairs.map(p => p.baseToken?.symbol));
    
    for (const pair of pairs) {
      const addr = (pair.pairAddress || '').toLowerCase();
      let priceEl, changeEl;
      
      let prefix;
      if (addr === MFERGPT_POOL.toLowerCase()) {
        priceEl = document.getElementById('mfergpt-price');
        changeEl = document.getElementById('mfergpt-change');
        prefix = 'mfergpt';
      } else if (addr === MFER_POOL.toLowerCase()) {
        priceEl = document.getElementById('mfer-price');
        changeEl = document.getElementById('mfer-change');
        prefix = 'mfer';
      } else continue;
      
      const mcap = Number(pair.marketCap || pair.fdv || 0);
      if (mcap >= 1_000_000) priceEl.textContent = `$${(mcap/1_000_000).toFixed(2)}M`;
      else if (mcap >= 1_000) priceEl.textContent = `$${(mcap/1_000).toFixed(1)}K`;
      else priceEl.textContent = mcap > 0 ? `$${mcap.toFixed(0)}` : '-';
      
      const change5m = pair.priceChange?.m5 ?? pair.priceChange?.h1 ?? pair.priceChange?.h6 ?? 0;
      const pct = Number(change5m) || 0;
      changeEl.textContent = `${pct >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(pct).toFixed(1)}%`;
      changeEl.className = `change ${pct > 0 ? 'up' : pct < 0 ? 'down' : 'flat'}`;
      
      const change24h = pair.priceChange?.h24 ?? 0;
      const pct24 = Number(change24h) || 0;
      const el24 = document.getElementById(`${prefix}-change-24h`);
      if (el24) {
        el24.textContent = `${pct24 >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(pct24).toFixed(1)}%`;
        el24.className = `change ${pct24 > 0 ? 'up' : pct24 < 0 ? 'down' : 'flat'}`;
      }
    }
  } catch (e) { console.error('pollPrices error:', e); }
}

const mentionsFeed = document.getElementById('mentions-feed');
async function pollMentions() {
  try {
    const res = await fetch(`http://${WS_HOST}:${STREAMER_PORT}/api/mentions`);
    if (!res.ok) return;
    const mentions = await res.json();
    mentionsFeed.innerHTML = mentions.reverse().map(m =>
      `<div class="feed-entry"><span class="username">@${escapeHtml(m.username)}</span><span class="text">${escapeHtml(m.text)}</span></div>`
    ).join('');
    mentionsFeed.scrollTop = mentionsFeed.scrollHeight;
  } catch(e) {}
}

const twitchFeed = document.getElementById('twitch-feed');
async function pollTwitch() {
  try {
    const res = await fetch(`http://${WS_HOST}:${STREAMER_PORT}/api/twitch-chat`);
    if (!res.ok) return;
    const msgs = await res.json();
    twitchFeed.innerHTML = msgs.map(m =>
      `<div class="feed-entry"><span class="username">${escapeHtml(m.username)}</span><span class="text">${escapeHtml(m.text)}</span></div>`
    ).join('');
    twitchFeed.scrollTop = twitchFeed.scrollHeight;
  } catch(e) {}
}

// Poll game state as fallback for team/trainer data
async function pollGameState() {
  try {
    const res = await fetch('/api/game-state');
    if (!res.ok) return;
    const data = await res.json();
    updateStats(data);
  } catch(e) {}
}
setInterval(pollGameState, 3000);
pollGameState();

connect();
setInterval(pollMinimap, 2000);
setInterval(pollModel, 10000);
setInterval(pollPrices, 30000);
setInterval(pollMentions, 15000);
setInterval(pollTwitch, 3000);
pollMinimap();
pollModel();
pollPrices();
pollMentions();
pollTwitch();
</script>
</body>
</html>
